import User from '../models/User.js';

export const upgradePremium = async (req, res) => {
    try {
        const user = await User.findById(req.user._id);

        if (!user) {
            return res.status(404).json({ message: 'Người dùng không tồn tại' });
        }
        const isPremium = req.body.plan === 'premium';

        if (isPremium) {
            const now = new Date();
            let premiumUntil;

            if (user.isPremium && user.premiumUntil && new Date(user.premiumUntil) > now) {
                // Extension: add 30 days to existing expiry
                premiumUntil = new Date(user.premiumUntil);
                premiumUntil.setDate(premiumUntil.getDate() + 30);
            } else {
                // New or renewal: 30 days from now
                premiumUntil = new Date(now);
                premiumUntil.setDate(premiumUntil.getDate() + 30);
            }

            user.isPremium = true;
            user.premiumUntil = premiumUntil;
        }

        await user.save();

        res.json({
            message: isPremium ? 'Nâng cấp/Gia hạn gói Premium thành công!' : 'Đã chuyển về gói Cơ Bản thành công!',
            user: {
                id: user._id,
                fullName: user.fullName,
                email: user.email,
                role: user.role,
                isPremium: user.isPremium,
                premiumUntil: user.premiumUntil,
            },
        });
    } catch (error) {
        console.error('Upgrade Premium Error:', error);
        res.status(500).json({ message: 'Lỗi server khi nâng cấp Premium' });
    }
};

export const updateProfile = async (req, res) => {
    try {
        const { fullName, anonymousName } = req.body;
        const user = await User.findById(req.user._id);

        if (!user) {
            return res.status(404).json({ message: 'Người dùng không tồn tại' });
        }

        if (fullName) user.fullName = fullName;

        if (!user.anonymous) user.anonymous = {};
        if (anonymousName) user.anonymous.name = anonymousName;
        // anonymous.id is auto-generated by model default value if missing

        await user.save();

        res.json({
            message: 'Cập nhật thông tin thành công',
            user: {
                id: user._id,
                fullName: user.fullName,
                email: user.email,
                role: user.role,
                isPremium: user.isPremium,
                premiumUntil: user.premiumUntil,
                anonymous: user.anonymous
            }
        });
    } catch (error) {
        console.error('Update Profile Error:', error);
        res.status(500).json({ message: 'Lỗi server khi cập nhật thông tin' });
    }
};

export const getMe = async (req, res) => {
    try {
        const user = await User.findById(req.user._id).select('-password');
        res.json(user);
    } catch (error) {
        res.status(500).json({ message: 'Lỗi server' });
    }
};

export const activateTrial = async (req, res) => {
    try {
        const user = await User.findById(req.user._id);
        if (!user) {
            return res.status(404).json({ message: 'Người dùng không tồn tại' });
        }

        if (user.hasUsedTrial) {
            return res.status(400).json({ message: 'Bạn đã sử dụng gói dùng thử miễn phí rồi.' });
        }

        const now = new Date();
        let premiumUntil;

        if (user.isPremium && user.premiumUntil && new Date(user.premiumUntil) > now) {
            // Extend existing
            premiumUntil = new Date(user.premiumUntil);
            premiumUntil.setDate(premiumUntil.getDate() + 7);
        } else {
            // New trial
            premiumUntil = new Date(now);
            premiumUntil.setDate(premiumUntil.getDate() + 7);
        }

        user.isPremium = true;
        user.premiumUntil = premiumUntil;
        user.hasUsedTrial = true;

        await user.save();

        res.json({
            message: 'Kích hoạt gói dùng thử 7 ngày thành công!',
            user: {
                id: user._id,
                fullName: user.fullName,
                email: user.email,
                role: user.role,
                isPremium: user.isPremium,
                premiumUntil: user.premiumUntil,
                hasUsedTrial: user.hasUsedTrial
            }
        });

    } catch (error) {
        console.error('Activate Trial Error:', error);
        res.status(500).json({ message: 'Lỗi server khi kích hoạt dùng thử' });
    }
};
